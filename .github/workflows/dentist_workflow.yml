name: dentist_workflow

on:
  push:
    branches:
      - main
      - dev
 
env:
  PROD_HOST: ${{ secrets.HOST }}
  DEV_HOST: ${{ secrets.DEV_HOST }}
  REDIS_URL: ${{ secrets.REDIS_URL }}
  MONGO_URL: ${{ secrets.MONGO_URL }}
  MONGO_DB_NAME: ${{ secrets.MONGO_DB_NAME }}
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  REDIS_STORAGE_URL: ${{ secrets.REDIS_STORAGE_URL }}
  CHANNEL_USERNAME: ${{ secrets.CHANNEL_USERNAME }}
  SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
  BOT_LINK: ${{ secrets.BOT_LINK }}
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  DEV_TOKEN: ${{ secrets.DEV_TOKEN }}
  TOKEN: ${{ secrets.TOKEN }}
  ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
  CERTBOT_EMAIL: ${{ secrets.CERTBOT_EMAIL }}

  WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
  INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
  INSTAGRAM_APP_ID: ${{ secrets.INSTAGRAM_APP_ID }}
  INSTAGRAM_APP_SECRET: ${{ secrets.INSTAGRAM_APP_SECRET }}
  INSTAGRAM_VERIFY_TOKEN: ${{ secrets.INSTAGRAM_VERIFY_TOKEN }}
  INSTAGRAM_BOT_NAME: ${{ secrets.INSTAGRAM_BOT_NAME }}
  INSTAGRAM_BOT_ID: ${{ secrets.INSTAGRAM_BOT_ID }}

  WHATSAPP_ACCESS_TOKEN: ${{ secrets.WHATSAPP_ACCESS_TOKEN }}
  WHATSAPP_BOT_NUMBER_ID: ${{ secrets.WHATSAPP_BOT_NUMBER_ID }}
  WHATSAPP_BOT_NUMBER: ${{ secrets.WHATSAPP_BOT_NUMBER }}
  WHATSAPP_APP_SECRET: ${{ secrets.WHATSAPP_APP_SECRET }}
  WHATSAPP_BUSINESS_ACCOUNT_ID: ${{ secrets.WHATSAPP_BUSINESS_ACCOUNT_ID }}
  WHATSAPP_VERIFY_TOKEN: ${{ secrets.WHATSAPP_VERIFY_TOKEN }}

  CONSTRUCTOR_TOKEN: ${{ secrets.CONSTRUCTOR_TOKEN }}
  CONSTRUCTOR_ASSISTANT_ID: ${{ secrets.CONSTRUCTOR_ASSISTANT_ID }}


  CRM_API_URL: ${{ secrets.CRM_API_URL }}
  CRM_CLIENT_ID: ${{ secrets.CRM_CLIENT_ID }}
  CRM_CLIENT_SECRET: ${{ secrets.CRM_CLIENT_SECRET }}

jobs:
  build_and_push_to_docker_hub:
    name: Push Docker images to Docker Hub
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repo
        uses: actions/checkout@v3

      # 1) Определяем, какие файлы изменились в этом пуше
      - name: Check changed files
        id: changes
        uses: tj-actions/changed-files@v34
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ============== 2) Сборка и пуш контейнеров =============

      # Mongo
      - name: Build and push Mongo
        if: contains( steps.changes.outputs.all_modified_files, 'mongo/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./mongo
          tags: ${{ secrets.DOCKER_USERNAME }}/mongo:latest

      # Redis
      - name: Build and push Mongo
        if: contains( steps.changes.outputs.all_modified_files, 'redis/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./redis
          tags: ${{ secrets.DOCKER_USERNAME }}/redis:latest

      # Backend (FastAPI + Celery)
      - name: Build and push Backend (FastAPI + Celery)
        if: contains( steps.changes.outputs.all_modified_files, 'backend/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./backend
          file: ./backend/Dockerfile
          tags: ${{ secrets.DOCKER_USERNAME }}/dentist_backend:latest

      # Bot (если бот в отдельной папке, например /backend/telegram_bot/)
      - name: Build and push Bot
        if: contains( steps.changes.outputs.all_modified_files, 'backend/telegram_bot/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./backend
          file: ./backend/telegram_bot/TelegramBotDockerfile
          tags: ${{ secrets.DOCKER_USERNAME }}/dentist_bot:latest

      # Frontend admin
      - name: Build and push Frontend admin
        if: contains( steps.changes.outputs.all_modified_files, 'frontend_admin/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./frontend_admin
          tags: ${{ secrets.DOCKER_USERNAME }}/dentist_frontend_admin:latest

      # Frontend chat
      - name: Build and push Frontend chat
        if: contains( steps.changes.outputs.all_modified_files, 'frontend_chat/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./frontend_chat
          tags: ${{ secrets.DOCKER_USERNAME }}/dentist_frontend_chat:latest

      # Nginx
      - name: Build and push Nginx proxy
        if: contains( steps.changes.outputs.all_modified_files, 'nginx/')
        uses: docker/build-push-action@v3
        with:
          push: true
          context: ./nginx
          tags: ${{ secrets.DOCKER_USERNAME }}/dentist_nginx:latest

  # ============== Дальше деплой на сервер =============

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps: 
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Determine deployment host
        id: set-host
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "HOST=${{ env.PROD_HOST }}" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "HOST=${{ env.DEV_HOST }}" >> $GITHUB_ENV
          fi

      - name: Set environment dynamically
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV=prod" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/dev" ]]; then
            echo "ENV=dev" >> $GITHUB_ENV
          fi

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: "backend/infra/docker-compose.yml"
          target: "~/"
          strip_components: 2
          overwrite: true

      - name: Copy all scripts to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          source: "scripts/**"
          target: "~/scripts/"
          strip_components: 1
          overwrite: true

      - name: Execute remote SSH commands to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.SSH_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
          script: |

            # Замок деплоя
            sudo mkdir -p /var/lock
            LOCK_FILE="/var/lock/dentist_deploy.lock"
            sudo touch "$LOCK_FILE"

            # Снимаем замок при любых завершениях
            cleanup() { sudo rm -f "$LOCK_FILE"; }
            trap cleanup EXIT INT TERM

            # Начало деплоя
            mkdir -p ~/scripts/backups ~/scripts/logs
 
            # Права на все скрипты
            chmod +x ~/scripts/*.sh
            chmod +x ~/scripts/backups/*.sh

            # CRON задачи (ежедневно в 00:00 по МСК → значит 21:00 по UTC)
            (crontab -l 2>/dev/null; echo "*/20 * * * * ~/scripts/restart_containers.sh >> ~/scripts/logs/restart_containers.log 2>&1") | sort -u | crontab -
            (crontab -l 2>/dev/null; echo "*/15 * * * * ~/scripts/restart_nginx.sh >> ~/scripts/logs/restart_nginx.log 2>&1") | sort -u | crontab -
            (crontab -l 2>/dev/null; echo "0 21 * * * ~/scripts/backups/create_backup_script.sh >> ~/scripts/logs/full_backup.log 2>&1") | sort -u | crontab -
            (crontab -l 2>/dev/null; echo "0 21 * * * ~/scripts/backups/create_mongo_backup.sh >> ~/scripts/logs/mongo_backup.log 2>&1") | sort -u | crontab -
            (crontab -l 2>/dev/null; echo "0 21 * * * ~/scripts/backups/create_media_backup_script.sh >> ~/scripts/logs/media_backup.log 2>&1") | sort -u | crontab -

            sudo docker system prune -a -f

            # Останавливаем старые контейнеры, чистим образы
            sudo docker-compose -f ~/docker-compose.yml down --remove-orphans

            # Создаём .env файл
            touch .env 
            cat > .env << EOF
            DOLLAR='$'
            HOST=${{ env.HOST }}
            REDIS_URL=${{ env.REDIS_URL }}
            MONGO_URL=${{ env.MONGO_URL }}
            MONGO_DB_NAME=${{ env.MONGO_DB_NAME }}
            OPENAI_API_KEY=${{ env.OPENAI_API_KEY }}
            GEMINI_API_KEY=${{ env.GEMINI_API_KEY }}
            REDIS_STORAGE_URL=${{ env.REDIS_STORAGE_URL }}
            CHANNEL_USERNAME=${{ env.CHANNEL_USERNAME }}
            SERVICE_NAME=${{ env.SERVICE_NAME }}
            BOT_LINK=${{ env.BOT_LINK }}
            TOKEN=$([ "${{ env.ENV }}" = "prod" ] && echo '${{ secrets.TOKEN }}' || echo '${{ secrets.DEV_TOKEN }}')
            ADMIN_CHAT_ID=${{ env.ADMIN_CHAT_ID }}
            CERTBOT_EMAIL=${{ env.CERTBOT_EMAIL }}
            WEATHER_API_KEY=${{ env.WEATHER_API_KEY }}
            INSTAGRAM_ACCESS_TOKEN=${{ env.INSTAGRAM_ACCESS_TOKEN }}
            INSTAGRAM_APP_ID=${{ env.INSTAGRAM_APP_ID }}
            INSTAGRAM_APP_SECRET=${{ env.INSTAGRAM_APP_SECRET }}
            INSTAGRAM_VERIFY_TOKEN=${{ env.INSTAGRAM_VERIFY_TOKEN }}
            INSTAGRAM_BOT_NAME=${{ env.INSTAGRAM_BOT_NAME }}
            INSTAGRAM_BOT_ID=${{ env.INSTAGRAM_BOT_ID }}
            WHATSAPP_ACCESS_TOKEN=${{ env.WHATSAPP_ACCESS_TOKEN }}
            WHATSAPP_BOT_NUMBER_ID=${{ env.WHATSAPP_BOT_NUMBER_ID }}
            WHATSAPP_BOT_NUMBER=${{ env.WHATSAPP_BOT_NUMBER }}
            WHATSAPP_APP_SECRET=${{ env.WHATSAPP_APP_SECRET }}
            WHATSAPP_BUSINESS_ACCOUNT_ID=${{ env.WHATSAPP_BUSINESS_ACCOUNT_ID }}
            WHATSAPP_VERIFY_TOKEN=${{ env.WHATSAPP_VERIFY_TOKEN }}
            CONSTRUCTOR_TOKEN=${{ env.CONSTRUCTOR_TOKEN }}
            CONSTRUCTOR_ASSISTANT_ID=${{ env.CONSTRUCTOR_ASSISTANT_ID }}
            CRM_API_URL=${{ env.CRM_API_URL }}
            CRM_CLIENT_ID=${{ env.CRM_CLIENT_ID }}
            CRM_CLIENT_SECRET=${{ env.CRM_CLIENT_SECRET }}
            EOF

            # Подтягиваем свежие образы (те, что мы успели запушить)
            sudo docker-compose -f ~/docker-compose.yml pull
            sudo docker-compose -f ~/docker-compose.yml up -d

            # Инициализация Mongo (реплика, если нужно)
            echo "Инициализируем MongoDB..."
            sudo docker-compose exec -T mongo mongosh --eval '
            if (rs.status().ok === 0) {
              rs.initiate({_id: "rs0", members: [{ _id: 0, host: "mongo:27017" }]})
            } else {
              print("✅ Репликация уже инициализирована.")
            }
            '

  # ============== Уведомления в Telegram =============

  send_message:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send success message
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ✅ Workflow ${{ github.workflow }} успешно выполнен!
            Ветка: ${{ github.ref_name }}
            Хост: ${{ env.HOST }}

      - name: Send failure message
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ❌ Workflow ${{ github.workflow }} завершился с ошибкой!
            Ветка: ${{ github.ref_name }}
            Хост: ${{ env.HOST }}
