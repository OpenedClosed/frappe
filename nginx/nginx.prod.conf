# user nginx;
# worker_processes 1;

# error_log /var/log/nginx/error.log warn;
# pid /var/run/nginx.pid;

# events
# {
#     worker_connections 1024;
# }

# http
# {
#     include /etc/nginx/mime.types;
#     default_type application/octet-stream;

#     include /etc/nginx/naxsi_core.rules;

#     # --- HTTP ‚Üí HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç ---
#     server
#     {
#         listen 80;
#         listen [::]:80;
#         server_name ${HOST};
#         return 301 https://${HOST}$request_uri;
#     }

#     # --- upstreams ---
#     upstream frappe_upstream
#     {
#         server frappe:8001;
#     }

#     upstream frappe_socketio_upstream
#     {
#         server frappe:9000;
#     }

#     upstream backend_upstream
#     {
#         server backend:8000;
#     }

#     upstream frontend_chat_upstream
#     {
#         server frontend_chat:3000;
#     }

#     upstream frontend_admin_upstream
#     {
#         server frontend_admin:3000;
#     }

#     server
#     {
#         listen 443 ssl http2 default_server;
#         listen [::]:443 ssl http2 default_server;
#         server_name ${HOST};
#         server_tokens off;
#         client_max_body_size 50M;

#         # --- TLS ---
#         ssl_certificate /etc/letsencrypt/live/${HOST}/fullchain.pem;
#         ssl_certificate_key /etc/letsencrypt/live/${HOST}/privkey.pem;
#         ssl_trusted_certificate /etc/letsencrypt/live/${HOST}/chain.pem;

#         ssl_protocols TLSv1.2 TLSv1.3;
#         ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
#         ssl_prefer_server_ciphers on;
#         ssl_session_cache shared:SSL:10m;
#         ssl_session_timeout 10m;

#         # --- Security headers ---
#         add_header X-XSS-Protection "1; mode=block" always;
#         add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
#         add_header Referrer-Policy "no-referrer-when-downgrade" always;
#         add_header Access-Control-Allow-Credentials true;
#         add_header Access-Control-Expose-Headers Access-Control-Allow-Origin;
#         add_header Content-Security-Policy "frame-ancestors 'self' https://${HOST} https://metrika.yandex.ru;" always;

#         # --- ACME challenge ---
#         location ~ /.well-known/acme-challenge
#         {
#             allow all;
#             root /certbot;
#         }

#         location = /error.html
#         {
#             root /usr/share/nginx/html;
#             internal;
#         }

#         # ==============================
#         # –ö–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞ ‚Üí –ø—É–±–ª–∏—á–Ω—ã–π —Ñ—Ä–æ–Ω—Ç (—á–∞—Ç)
#         # ==============================
#         # location /
#         # {
#         #     proxy_pass http://frontend_chat_upstream/;
#         #     proxy_redirect off;
#         #     proxy_set_header Host $host;
#         #     proxy_set_header X-Real-IP $remote_addr;
#         #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         #     proxy_set_header X-Forwarded-Proto $scheme;
#         #     proxy_set_header X-Forwarded-Host $host;
#         #     proxy_set_header Upgrade $http_upgrade;
#         #     proxy_set_header Connection "upgrade";
#         #     include /etc/nginx/naxsi.rules;
#         # }

#         # –ß–∞—Ç
#         location /chat/
#         {
#             proxy_pass http://frontend_chat_upstream/;
#             proxy_redirect off;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             include /etc/nginx/naxsi.rules;
#         }

#         # –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
#         location /personal_account/
#         {
#             proxy_pass http://frontend_chat_upstream/personal_account/;
#             proxy_redirect off;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             include /etc/nginx/naxsi.rules;
#         }

#         # ==============================
#         # /admin/* ‚Üí Frappe (Desk)
#         # ==============================
#         location ^~ /admin/
#         {
#             proxy_pass http://frappe_upstream/;
#             proxy_redirect off;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             include /etc/nginx/naxsi.rules;
#         }

#         # ========= –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï Frappe –ø—É—Ç–∏ (–¥–æ–ª–∂–Ω—ã –∏–¥—Ç–∏ –î–û –æ–±—â–µ–≥–æ /api/) =========
#         # —Å–∏—Å—Ç–µ–º–Ω—ã–π JS Frappe (–ª–æ–≥–∏–Ω —Ç—è–Ω–µ—Ç –∞–±—Å–æ–ª—é—Ç–æ–º)
#         location = /website_script.js
#         {
#             proxy_pass http://frappe_upstream/website_script.js;
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_read_timeout 300s;
#         }

#         # REST ERPNext/Frappe
#         location /api/method/
#         {
#             proxy_pass http://frappe_upstream/api/method/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_read_timeout 300s;
#         }

#         location /api/resource/
#         {
#             proxy_pass http://frappe_upstream/api/resource/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_read_timeout 300s;
#         }
#         # ========= /–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï =========

#         # ==============================
#         # üîÅ –†–µ–¥–∏—Ä–µ–∫—Ç—ã Frappe ‚Üí /admin/app
#         # ==============================
#         # —Ç–æ—á–Ω—ã–π /app ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ –∞–¥–º–∏–Ω–∫—É
#         location = /app
#         {
#             return 301 https://$host/admin/app;
#         }

#         # –≤—Å—ë –ø–æ–¥ /app/... ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ö–≤–æ—Å—Ç–∞ –∏ query
#         location ^~ /app/
#         {
#             return 301 https://$host/admin$request_uri;
#         }

#         # –Ω–∞ –≤—Å—è–∫–∏–π /desk ‚Üí —Ç–æ–∂–µ –≤ –∞–¥–º–∏–Ω–∫—É
#         location = /desk
#         {
#             return 301 https://$host/admin/app;
#         }

#         location ^~ /desk/
#         {
#             return 301 https://$host/admin/app;
#         }
#         # ==============================

#         # Backend API (—Ç–≤–æ–π FastAPI)
#         location /api/
#         {
#             proxy_pass http://backend_upstream/api/;
#             proxy_redirect off;
#             proxy_set_header Host ${HOST};
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             proxy_connect_timeout 300s;
#             proxy_send_timeout 300s;
#             proxy_read_timeout 300s;
#             include /etc/nginx/naxsi.rules;
#         }

#         # –ú–µ–¥–∏–∞/—Å—Ç–∞—Ç–∏–∫–∞
#         location /media/
#         {
#             alias /var/html/media/;
#         }

#         location /api/static/
#         {
#             alias /var/html/static/;
#         }

#         location /api/media/
#         {
#             alias /var/html/media/;
#         }

#         # ==============================
#         # Assets –∏ —Ñ–∞–π–ª—ã Frappe
#         # ==============================
#         location /assets/
#         {
#             proxy_pass http://frappe_upstream/assets/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_read_timeout 300s;
#             expires 1y;
#             add_header Cache-Control "public, immutable";
#         }

#         location /files/
#         {
#             proxy_pass http://frappe_upstream/files/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header X-Forwarded-Proto $scheme;
#             expires 1h;
#             add_header Cache-Control "public";
#         }

#         # Socket.IO (Frappe)
#         location /socket.io/
#         {
#             proxy_pass http://frappe_socketio_upstream/socket.io/;
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection "upgrade";
#             proxy_set_header X-Forwarded-Proto $scheme;
#             proxy_set_header X-Forwarded-Host $host;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             include /etc/nginx/naxsi.rules;
#         }
#     }
# }


user  nginx;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    include /etc/nginx/naxsi_core.rules;

    # --- HTTP ‚Üí HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç ---
    server {
        listen 80;
        listen [::]:80;
        server_name ${HOST};
        return 301 https://${HOST}$request_uri;
    }

    upstream frappe_upstream {
        server frappe:8001;
    }

    upstream frappe_socketio_upstream {
        server frappe:9000;
    }

    upstream bot_upstream {
        server bot:9999;
    }

    server {
        listen 443 ssl http2 default_server;
        listen [::]:443 ssl http2 default_server;
        server_name ${HOST};
        server_tokens off;
        client_max_body_size 50M;

        ssl_certificate /etc/letsencrypt/live/${HOST}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/${HOST}/privkey.pem;
        ssl_trusted_certificate /etc/letsencrypt/live/${HOST}/chain.pem;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        add_header X-XSS-Protection "1; mode=block" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header Content-Security-Policy "frame-ancestors 'self' https://sander-firsov.ru https://metrika.yandex.ru;" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Access-Control-Allow-Credentials true;
        add_header Access-Control-Expose-Headers Access-Control-Allow-Origin;

        # --- Let's Encrypt challenge ---
        location ~ /.well-known/acme-challenge {
            allow all;
            root /certbot;
        }

        location = /error.html {
            root /usr/share/nginx/html;
            internal;
        }

        # --- Frappe WEB ---
        location / {
            proxy_pass http://frappe_upstream/;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "upgrade";
            include /etc/nginx/naxsi.rules;
        }

        # --- Frappe Socket.IO ---
        location /socket.io/ {
            proxy_pass http://frappe_socketio_upstream/socket.io/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            include /etc/nginx/naxsi.rules;
        }

        # --- –ú–µ–¥–∏–∞/—Å—Ç–∞—Ç–∏–∫–∞ ---
        location /media/ {
            alias /var/html/media/;
        }

        location /api/static/ {
            alias /var/html/static/;
        }

        location /api/media/ {
            alias /var/html/media/;
        }

        # --- Assets Frappe ---
        location /assets/ {
            alias /workspace/sites/assets/;
            access_log off;
            expires 1M;
            add_header Cache-Control "public";
            try_files $uri =404;
        }
    }
}
